<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <meta name="theme-color" content="#111">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’ª</text></svg>">
  <title>CarlaFit</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#111;color:#fff;min-height:100vh}
    header{background:linear-gradient(135deg,#1a1a1a 0%,#222 100%);padding:1rem;border-bottom:1px solid #333;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
    .header-content{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
    .header-left{text-align:left}
    .header-right{display:flex;align-items:center;gap:0.5rem}
    .logo{font-size:1.8rem;font-weight:700;display:flex;align-items:center;gap:0.5rem}
    .sub{font-size:0.7rem;color:#888;margin-top:0.25rem;letter-spacing:0.5px}
    #weather-widget{font-size:0.85rem;color:#fff;display:flex;align-items:center;gap:0.75rem;padding:0.5rem 1rem;background:rgba(255,255,255,0.05);border-radius:12px;border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(10px);transition:all 0.2s ease}
    #weather-widget:hover{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.15)}
    .weather-icon{width:40px;height:40px;object-fit:contain}
    .weather-temp{font-size:1.4rem;font-weight:700;color:#4ade80}
    .weather-desc{font-size:0.7rem;color:#aaa;text-transform:capitalize}
    .weather-location{font-size:0.65rem;color:#666;margin-top:2px}
    .weather-error{font-size:0.7rem;color:#f87171}
    .weather-loading{font-size:0.7rem;color:#888;animation:pulse 1.5s ease-in-out infinite}
    @keyframes pulse{0%,100%{opacity:0.5}50%{opacity:1}}
    .days{display:flex;gap:0.25rem;overflow-x:auto;padding:0.75rem 1rem;background:#151515;-webkit-overflow-scrolling:touch}
    .day-btn{flex-shrink:0;width:52px;background:#222;border:none;color:#888;padding:0.5rem;border-radius:8px;text-align:center;cursor:pointer}
    .day-btn.active{background:#4ade80;color:#000}
    .day-btn.empty{opacity:0.3;pointer-events:none}
    .day-btn span{display:block;font-size:0.6rem;text-transform:uppercase}
    .day-btn strong{display:block;font-size:1.1rem}
    .container{max-width:900px;margin:0 auto;padding:1rem}
    .time-header{font-size:0.7rem;color:#4ade80;text-transform:uppercase;padding:0.75rem 0;border-bottom:1px solid #222;margin-top:1rem}
    .card{background:#1a1a1a;border-radius:10px;padding:0.875rem;margin-top:0.5rem;display:flex;align-items:center;gap:0.75rem;cursor:pointer;border-left:3px solid #555}
    .card:active{transform:scale(0.98)}
    .card.yoga,.card.pilates{border-color:#a78bfa}
    .card.spin{border-color:#f472b6}
    .card.strength{border-color:#fb923c}
    .card.cardio{border-color:#f87171}
    .card.aqua{border-color:#38bdf8}
    .card.dance{border-color:#facc15}
    .card.mind_body{border-color:#2dd4bf}
    .icon{font-size:1.3rem;width:32px;text-align:center}
    .info{flex:1;min-width:0}
    .name{font-weight:600;font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta{font-size:0.7rem;color:#666}
    .time{font-weight:700;font-size:0.85rem;color:#4ade80}
    .empty{text-align:center;padding:3rem;color:#444}
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:200;display:none;align-items:flex-end;justify-content:center}
    .modal-bg.show{display:flex}
    .modal{background:#1a1a1a;width:100%;max-width:500px;border-radius:16px 16px 0 0;padding:1.25rem}
    .modal h2{font-size:1.1rem;margin-bottom:0.25rem}
    .modal .cat{font-size:0.7rem;color:#4ade80;text-transform:uppercase;margin-bottom:1rem}
    .modal .row{display:flex;justify-content:space-between;padding:0.6rem 0;border-bottom:1px solid #222;font-size:0.85rem}
    .modal .label{color:#666}
    .gcal-btn{display:block;width:100%;background:#4ade80;color:#000;border:none;padding:0.875rem;border-radius:8px;font-weight:600;margin-top:1rem;cursor:pointer}
    .close-btn{width:100%;background:#333;color:#fff;border:none;padding:0.75rem;border-radius:8px;margin-top:0.5rem;cursor:pointer}
    footer{text-align:center;font-size:0.6rem;color:#333;padding:1rem}
    @media(min-width:768px){
      .desktop{display:block}
      .mobile{display:none}
      .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#222;border-radius:8px;overflow:hidden;margin-bottom:1rem}
      .cal-head{background:#1a1a1a;padding:0.5rem;text-align:center;font-size:0.7rem;color:#666;text-transform:uppercase}
      .cal-day{background:#1a1a1a;min-height:80px;padding:0.5rem;cursor:pointer;transition:background 0.2s}
      .cal-day:hover{background:#222}
      .cal-day.active{background:#252}
      .cal-day.empty{opacity:0.3;pointer-events:none}
      .cal-num{font-size:0.9rem;font-weight:600;margin-bottom:0.25rem}
      .cal-day.today .cal-num{color:#4ade80}
      .cal-count{font-size:0.65rem;color:#666}
      .split{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
      .modal{border-radius:16px;margin:auto}
    }
    @media(max-width:767px){.desktop{display:none}.mobile{display:block}header{text-align:center}.header-content{display:block}.header-left{text-align:center}}
  </style>
</head>
<body>
<header>
  <div class="header-content">
    <div class="header-left">
      <div class="logo">ğŸ’ª CarlaFit</div>
      <div class="sub">Carla Madison Rec Center</div>
    </div>
    <div class="header-right desktop" id="weather-widget">
      <!-- Weather content injected by JavaScript -->
    </div>
  </div>
</header>

<div class="mobile">
  <div class="days" id="days"></div>
</div>

<div class="container">
  <div class="desktop" id="calendar"></div>
  <div id="app"></div>
</div>

<div class="modal-bg" id="modal"><div class="modal" id="mc"></div></div>
<footer id="footer"></footer>

<script>
const IC={yoga:"ğŸ§˜",pilates:"ğŸ¤¸",spin:"ğŸš´",strength:"ğŸ’ª",cardio:"ğŸƒ",aqua:"ğŸŠ",dance:"ğŸ’ƒ",mind_body:"ğŸ§˜â€â™€ï¸",general:"ğŸ“‹"};
const LOC="Carla Madison Recreation Center, 2401 E Colfax Ave, Denver, CO 80206";
let D=[],DATES=[],SEL=0;

// Weather API configuration
const WEATHER_CONFIG={
  API_KEY:'4226171962a8247cbe74bb7bc108564a',
  LAT:39.7392,
  LON:-104.9903,
  UNITS:'imperial',
  CACHE_DURATION:30*60*1000,
  CACHE_KEY:'weather_cache'
};

// Weather emoji fallback mapping
const WEATHER_EMOJI={
  '01d':'â˜€ï¸','01n':'ğŸŒ™','02d':'â›…','02n':'â˜ï¸','03d':'â˜ï¸','03n':'â˜ï¸',
  '04d':'â˜ï¸','04n':'â˜ï¸','09d':'ğŸŒ§ï¸','09n':'ğŸŒ§ï¸','10d':'ğŸŒ¦ï¸','10n':'ğŸŒ§ï¸',
  '11d':'â›ˆï¸','11n':'â›ˆï¸','13d':'â„ï¸','13n':'â„ï¸','50d':'ğŸŒ«ï¸','50n':'ğŸŒ«ï¸'
};

async function fetchWeather(){
  if(window.innerWidth<768)return;
  const widget=document.getElementById('weather-widget');
  if(!widget)return;
  const cache=getWeatherCache();
  if(cache&&Date.now()-cache.timestamp<WEATHER_CONFIG.CACHE_DURATION){
    renderWeather(cache.data);
    return;
  }
  widget.innerHTML='<div class="weather-loading">Loading weather...</div>';
  try{
    const url=`https://api.openweathermap.org/data/2.5/weather?lat=${WEATHER_CONFIG.LAT}&lon=${WEATHER_CONFIG.LON}&appid=${WEATHER_CONFIG.API_KEY}&units=${WEATHER_CONFIG.UNITS}`;
    const response=await fetch(url);
    if(!response.ok){
      const errorData=await response.json().catch(()=>({}));
      console.error('Weather API error:',errorData);
      throw new Error(`${response.status}: ${errorData.message||'Unknown error'}`);
    }
    const data=await response.json();
    setWeatherCache(data);
    renderWeather(data);
  }catch(error){
    console.error('Weather fetch failed:',error);
    widget.innerHTML='<span style="font-size:2rem">ğŸŒ¤ï¸</span><div><div class="weather-temp">Denver</div><div class="weather-desc">Colorado</div></div>';
  }
}

function renderWeather(data){
  const widget=document.getElementById('weather-widget');
  if(!widget)return;
  const temp=Math.round(data.main.temp);
  const desc=data.weather[0].description;
  const icon=data.weather[0].icon;
  const iconUrl=`https://openweathermap.org/img/wn/${icon}@2x.png`;
  const emojiIcon=WEATHER_EMOJI[icon]||'ğŸŒ¡ï¸';
  widget.innerHTML=`
    <img src="${iconUrl}"
         alt="${desc}"
         class="weather-icon"
         onerror="this.style.display='none';this.nextElementSibling.style.display='inline'">
    <span style="display:none;font-size:2rem">${emojiIcon}</span>
    <div>
      <div class="weather-temp">${temp}Â°F</div>
      <div class="weather-desc">${desc}</div>
    </div>
  `;
}

function getWeatherCache(){
  try{
    const cached=localStorage.getItem(WEATHER_CONFIG.CACHE_KEY);
    return cached?JSON.parse(cached):null;
  }catch{
    return null;
  }
}

function setWeatherCache(data){
  try{
    const cache={data:data,timestamp:Date.now()};
    localStorage.setItem(WEATHER_CONFIG.CACHE_KEY,JSON.stringify(cache));
  }catch(e){
    console.warn('Failed to cache weather data:',e);
  }
}

async function init(){
  try{
    const r=await fetch("data/schedule.json",{cache:"no-store"});
    const d=await r.json();
    D=d.classes||[];
    DATES=[...new Set(D.map(c=>c.date))].sort();
    document.getElementById("footer").textContent="Updated "+timeAgo(d.last_updated)+" â€¢ Tap class for details";
    buildUI();
    fetchWeather();
  }catch(e){document.getElementById("app").innerHTML='<div class="empty">Could not load schedule</div>';}
}

function buildUI(){
  // Mobile day buttons
  const db=document.getElementById("days");
  const today=new Date().toISOString().split("T")[0];
  db.innerHTML=DATES.map((dt,i)=>{
    const d=new Date(dt+"T12:00:00");
    const lbl=dt===today?"Today":d.toLocaleDateString("en-US",{weekday:"short"});
    return'<button class="day-btn'+(i===0?" active":"")+'" data-i="'+i+'"><span>'+lbl+'</span><strong>'+d.getDate()+'</strong></button>';
  }).join("");
  db.querySelectorAll(".day-btn").forEach(b=>b.onclick=()=>{SEL=+b.dataset.i;db.querySelectorAll(".day-btn").forEach(x=>x.classList.remove("active"));b.classList.add("active");render();});

  // Desktop calendar
  const cal=document.getElementById("calendar");
  const days=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  let h='<div class="cal-grid">'+days.map(d=>'<div class="cal-head">'+d+'</div>').join("");
  const first=new Date(DATES[0]+"T12:00:00");
  const last=new Date(DATES[DATES.length-1]+"T12:00:00");
  const start=new Date(first);start.setDate(start.getDate()-start.getDay());
  for(let i=0;i<14;i++){
    const curr=new Date(start);curr.setDate(start.getDate()+i);
    const iso=curr.toISOString().split("T")[0];
    const cnt=D.filter(c=>c.date===iso).length;
    const hasData=DATES.includes(iso);
    const isToday=iso===today;
    const idx=DATES.indexOf(iso);
    h+='<div class="cal-day'+(hasData?"":" empty")+(isToday?" today":"")+(idx===SEL?" active":"")+'" data-i="'+idx+'"><div class="cal-num">'+curr.getDate()+'</div>'+(cnt?'<div class="cal-count">'+cnt+' classes</div>':"")+'</div>';
  }
  cal.innerHTML=h+'</div>';
  cal.querySelectorAll(".cal-day:not(.empty)").forEach(el=>el.onclick=()=>{SEL=+el.dataset.i;buildUI();render();});
  render();
}

function render(){
  const dt=DATES[SEL];
  if(!dt){document.getElementById("app").innerHTML='<div class="empty">No classes</div>';return;}
  let list=D.filter(c=>c.date===dt).sort((a,b)=>getH(a.time)-getH(b.time));
  const today=new Date().toISOString().split("T")[0];
  if(dt===today){
    const now=new Date();
    const nowMin=now.getHours()*60+now.getMinutes();
    list=list.filter(c=>{
      const m=c.time.match(/(\d+):(\d+)(am|pm)/i);
      if(!m)return true;
      let h=+m[1],min=+m[2];
      const ap=m[3].toLowerCase();
      if(ap==="pm"&&h!==12)h+=12;
      if(ap==="am"&&h===12)h=0;
      const classMin=h*60+min;
      return classMin-nowMin>30;
    });
  }
  const grp={m:[],a:[],e:[]};
  list.forEach(c=>{const h=getH(c.time);(h<12?grp.m:h<17?grp.a:grp.e).push(c);});
  let html="";
  if(grp.m.length)html+=sec("â˜€ï¸ Morning",grp.m);
  if(grp.a.length)html+=sec("ğŸŒ¤ Afternoon",grp.a);
  if(grp.e.length)html+=sec("ğŸŒ™ Evening",grp.e);
  document.getElementById("app").innerHTML=html||'<div class="empty">No classes</div>';
  document.querySelectorAll(".card").forEach(el=>el.onclick=()=>modal(D.find(c=>c.date===dt&&c.name===el.dataset.n&&c.time===el.dataset.t)));
}

function sec(t,arr){
  return'<div class="time-header">'+t+'</div>'+arr.map(c=>'<div class="card '+(c.category||"general")+'" data-n="'+esc(c.name)+'" data-t="'+c.time+'"><div class="icon">'+(IC[c.category]||IC.general)+'</div><div class="info"><div class="name">'+clean(c.name)+'</div><div class="meta">'+(c.instructor?cleanI(c.instructor):c.room||"")+'</div></div><div class="time">'+fmtT(c.time,c.duration_minutes)+'</div></div>').join("");
}

function modal(c){
  if(!c)return;
  const d=new Date(c.date+"T12:00:00");
  document.getElementById("mc").innerHTML='<h2>'+clean(c.name)+'</h2><div class="cat">'+(c.category||"general").replace("_"," ")+'</div><div class="row"><span class="label">Date</span><span>'+d.toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric"})+'</span></div><div class="row"><span class="label">Time</span><span>'+fmtT(c.time,c.duration_minutes)+'</span></div><div class="row"><span class="label">Duration</span><span>'+(c.duration_minutes||60)+' min</span></div><div class="row"><span class="label">Instructor</span><span>'+(c.instructor?cleanI(c.instructor):"TBD")+'</span></div><div class="row"><span class="label">Room</span><span>'+(c.room||"TBD")+'</span></div><button class="gcal-btn" onclick="gcal()">ğŸ“… Add to Calendar</button><button class="close-btn" onclick="closeM()">Close</button>';
  document.getElementById("modal").classList.add("show");
  window._C=c;
}
function closeM(){document.getElementById("modal").classList.remove("show");}
document.getElementById("modal").onclick=e=>{if(e.target.id==="modal")closeM();};

function gcal(){
  const c=window._C,st=new Date(c.date+"T"+parseT(c.time)),en=new Date(st.getTime()+(c.duration_minutes||60)*60000);
  const f=d=>d.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";
  window.open("https://calendar.google.com/calendar/render?action=TEMPLATE&text="+encodeURIComponent(clean(c.name))+"&dates="+f(st)+"/"+f(en)+"&location="+encodeURIComponent(LOC)+"&details="+encodeURIComponent("Instructor: "+(c.instructor?cleanI(c.instructor):"TBD")+"\nRoom: "+(c.room||"TBD")),"_blank");
}

function getH(t){const m=t.match(/(\d+):(.*?)(am|pm)/i);if(!m)return 12;let h=+m[1];if(m[3].toLowerCase()==="pm"&&h!==12)h+=12;if(m[3].toLowerCase()==="am"&&h===12)h=0;return h;}
function parseT(t){const m=t.match(/(\d+):(\d+)(am|pm)/i);if(!m)return"12:00:00";let h=+m[1];if(m[3].toLowerCase()==="pm"&&h!==12)h+=12;if(m[3].toLowerCase()==="am"&&h===12)h=0;return String(h).padStart(2,"0")+":"+m[2]+":00";}
function fmtT(t,dur){const m=t.match(/(\d+):(\d+)(am|pm)/i);if(!m)return t;let h=+m[1],min=+m[2];const ap=m[3].toLowerCase();if(ap==="pm"&&h!==12)h+=12;if(ap==="am"&&h===12)h=0;const start=h*60+min;const end=start+(dur||60);const eh=Math.floor(end/60)%24,emin=end%60;const sh12=h>12?h-12:h===0?12:h,eh12=eh>12?eh-12:eh===0?12:eh;const sap=h>=12?"PM":"AM",eap=eh>=12?"PM":"AM";return sh12+":"+(min<10?"0":"")+min+sap+" - "+eh12+":"+(emin<10?"0":"")+emin+eap;}
function clean(n){return n.replace(/&reg;/g,"Â®").replace(/CANCELED:\s*/gi,"âŒ ").replace(/<[^>]*>/g,"");}
function cleanI(i){return i.replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim();}
function esc(s){return s.replace(/"/g,"&quot;");}
function timeAgo(iso){const m=Math.floor((new Date()-new Date(iso))/60000);return m<60?m+"m ago":m<1440?Math.floor(m/60)+"h ago":Math.floor(m/1440)+"d ago";}

// Re-fetch weather on resize if crossing breakpoint
let wasDesktop=window.innerWidth>=768;
window.addEventListener('resize',()=>{
  const isDesktop=window.innerWidth>=768;
  if(isDesktop&&!wasDesktop){
    fetchWeather();
  }
  wasDesktop=isDesktop;
});

init();
</script>
</body>
</html>
