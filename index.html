<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#111">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>CarlaFit</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#111;color:#fff;min-height:100vh;padding-bottom:2rem}
    header{background:#1a1a1a;padding:1rem;position:sticky;top:0;z-index:100;border-bottom:1px solid #333}
    .logo{font-size:1.1rem;font-weight:700;text-align:center;margin-bottom:0.75rem}
    .days{display:flex;gap:0.25rem;overflow-x:auto;padding:0.25rem 0;-webkit-overflow-scrolling:touch}
    .day-btn{flex:1;min-width:48px;background:#222;border:none;color:#888;padding:0.5rem 0.25rem;border-radius:8px;text-align:center;cursor:pointer;transition:all 0.2s}
    .day-btn.active{background:#4ade80;color:#000}
    .day-btn span{display:block;font-size:0.65rem;text-transform:uppercase}
    .day-btn strong{display:block;font-size:1rem}
    main{max-width:500px;margin:0 auto;padding:0.75rem}
    .time-section{margin-bottom:1.25rem}
    .time-header{font-size:0.7rem;color:#4ade80;text-transform:uppercase;letter-spacing:0.05em;padding:0.5rem 0;border-bottom:1px solid #222;margin-bottom:0.5rem}
    .card{background:#1a1a1a;border-radius:10px;padding:0.875rem;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.75rem;cursor:pointer;border-left:3px solid #555;transition:transform 0.15s}
    .card:active{transform:scale(0.98)}
    .card.yoga,.card.pilates{border-color:#a78bfa}
    .card.spin{border-color:#f472b6}
    .card.strength{border-color:#fb923c}
    .card.cardio{border-color:#f87171}
    .card.aqua{border-color:#38bdf8}
    .card.dance{border-color:#facc15}
    .card.mind_body{border-color:#2dd4bf}
    .icon{font-size:1.4rem;width:36px;text-align:center}
    .info{flex:1;min-width:0}
    .name{font-weight:600;font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta{font-size:0.75rem;color:#777}
    .time{font-weight:700;font-size:0.85rem;color:#4ade80}
    .empty{text-align:center;padding:3rem 1rem;color:#555}
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:200;display:none;align-items:flex-end;justify-content:center}
    .modal-bg.show{display:flex}
    .modal{background:#1a1a1a;width:100%;max-width:500px;border-radius:16px 16px 0 0;padding:1.5rem;max-height:70vh;overflow-y:auto}
    .modal h2{font-size:1.2rem;margin-bottom:0.25rem}
    .modal .cat{font-size:0.75rem;color:#4ade80;text-transform:uppercase;margin-bottom:1rem}
    .modal .row{display:flex;justify-content:space-between;padding:0.75rem 0;border-bottom:1px solid #333;font-size:0.9rem}
    .modal .row:last-child{border:none}
    .modal .label{color:#777}
    .modal .val{font-weight:500;text-align:right}
    .gcal-btn{display:block;width:100%;background:#4ade80;color:#000;border:none;padding:1rem;border-radius:10px;font-size:1rem;font-weight:600;margin-top:1rem;cursor:pointer}
    .close-btn{display:block;width:100%;background:#333;color:#fff;border:none;padding:0.75rem;border-radius:10px;font-size:0.9rem;margin-top:0.5rem;cursor:pointer}
    footer{text-align:center;font-size:0.65rem;color:#444;padding:1rem}
  </style>
</head>
<body>
<header>
  <div class="logo">üí™ CarlaFit</div>
  <div class="days" id="days"></div>
</header>
<main id="app"></main>
<div class="modal-bg" id="modal"><div class="modal" id="modal-content"></div></div>
<footer id="footer"></footer>
<script>
const ICONS={yoga:"üßò",pilates:"ü§∏",spin:"üö¥",strength:"üí™",cardio:"üèÉ",aqua:"üèä",dance:"üíÉ",mind_body:"üßò‚Äç‚ôÄÔ∏è",general:"üìã"};
const LOC="Carla Madison Recreation Center, 2401 E Colfax Ave, Denver, CO 80206";
let DATA=[],SEL=0;

async function init(){
  try{
    const r=await fetch("data/schedule.json",{cache:"no-store"});
    const d=await r.json();
    DATA=d.classes||[];
    document.getElementById("footer").innerHTML="Updated "+timeAgo(d.last_updated);
    buildDays();
    render();
  }catch(e){document.getElementById("app").innerHTML='<div class="empty">Could not load</div>';}
}

function buildDays(){
  const c=document.getElementById("days");
  let h="";
  for(let i=0;i<7;i++){
    const dt=new Date();dt.setDate(dt.getDate()+i);
    const lbl=i===0?"Today":dt.toLocaleDateString("en-US",{weekday:"short"});
    const num=dt.getDate();
    h+='<button class="day-btn'+(i===0?' active':'')+'" data-i="'+i+'"><span>'+lbl+'</span><strong>'+num+'</strong></button>';
  }
  c.innerHTML=h;
  c.querySelectorAll(".day-btn").forEach(b=>b.onclick=()=>{
    SEL=+b.dataset.i;
    c.querySelectorAll(".day-btn").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    render();
  });
}

function render(){
  const dt=new Date();dt.setDate(dt.getDate()+SEL);
  const key=dt.toISOString().split("T")[0];
  const list=DATA.filter(c=>c.date===key).sort((a,b)=>getH(a.time)-getH(b.time));
  if(!list.length){document.getElementById("app").innerHTML='<div class="empty">No classes this day</div>';return;}
  const grp={morning:[],afternoon:[],evening:[]};
  list.forEach(c=>{const h=getH(c.time);if(h<12)grp.morning.push(c);else if(h<17)grp.afternoon.push(c);else grp.evening.push(c);});
  let html="";
  if(grp.morning.length)html+=section("‚òÄÔ∏è Morning",grp.morning);
  if(grp.afternoon.length)html+=section("üå§ Afternoon",grp.afternoon);
  if(grp.evening.length)html+=section("üåô Evening",grp.evening);
  document.getElementById("app").innerHTML=html;
  document.querySelectorAll(".card").forEach((el,i)=>el.onclick=()=>showModal(list[el.dataset.idx]));
}

function section(t,arr){
  let h='<div class="time-section"><div class="time-header">'+t+'</div>';
  arr.forEach((c,i)=>{
    const cat=c.category||"general";
    const idx=DATA.indexOf(c);
    h+='<div class="card '+cat+'" data-idx="'+idx+'"><div class="icon">'+ICONS[cat]+'</div><div class="info"><div class="name">'+clean(c.name)+'</div><div class="meta">'+(c.instructor?cleanI(c.instructor):c.room||"")+'</div></div><div class="time">'+fmtTime(c.time)+'</div></div>';
  });
  return h+'</div>';
}

function showModal(c){
  const cat=c.category||"general";
  const dt=new Date(c.date+"T12:00:00");
  const h='<h2>'+clean(c.name)+'</h2><div class="cat">'+cat.replace("_"," ")+'</div>'+
    '<div class="row"><span class="label">Date</span><span class="val">'+dt.toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric"})+'</span></div>'+
    '<div class="row"><span class="label">Time</span><span class="val">'+c.time+'</span></div>'+
    '<div class="row"><span class="label">Duration</span><span class="val">'+(c.duration_minutes||60)+' min</span></div>'+
    '<div class="row"><span class="label">Instructor</span><span class="val">'+(c.instructor?cleanI(c.instructor):"TBD")+'</span></div>'+
    '<div class="row"><span class="label">Room</span><span class="val">'+(c.room||"TBD")+'</span></div>'+
    '<button class="gcal-btn" onclick="addCal()">üìÖ Add to Calendar</button>'+
    '<button class="close-btn" onclick="closeModal()">Close</button>';
  document.getElementById("modal-content").innerHTML=h;
  document.getElementById("modal").classList.add("show");
  window.SELC=c;
}
function closeModal(){document.getElementById("modal").classList.remove("show");}
document.getElementById("modal").onclick=e=>{if(e.target.id==="modal")closeModal();};

function addCal(){
  const c=window.SELC;
  const st=new Date(c.date+"T"+parseT(c.time));
  const en=new Date(st.getTime()+(c.duration_minutes||60)*60000);
  const fmt=d=>d.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";
  const url="https://calendar.google.com/calendar/render?action=TEMPLATE&text="+encodeURIComponent(clean(c.name))+"&dates="+fmt(st)+"/"+fmt(en)+"&location="+encodeURIComponent(LOC)+"&details="+encodeURIComponent("Instructor: "+(c.instructor?cleanI(c.instructor):"TBD")+"\nRoom: "+(c.room||"TBD"));
  window.open(url,"_blank");
}

function getH(t){const m=t.match(/(\d+):(.*?)(am|pm)/i);if(!m)return 12;let h=+m[1];if(m[3].toLowerCase()==="pm"&&h!==12)h+=12;if(m[3].toLowerCase()==="am"&&h===12)h=0;return h;}
function parseT(t){const m=t.match(/(\d+):(\d+)(am|pm)/i);if(!m)return"12:00:00";let h=+m[1];if(m[3].toLowerCase()==="pm"&&h!==12)h+=12;if(m[3].toLowerCase()==="am"&&h===12)h=0;return String(h).padStart(2,"0")+":"+m[2]+":00";}
function fmtTime(t){return t.split("-")[0].replace(/(\d+:\d+)(am|pm)/i,(m,x,ap)=>x+" "+ap.toUpperCase());}
function clean(n){return n.replace(/&reg;/g,"¬Æ").replace(/CANCELED:\s*/gi,"‚ùå ").replace(/<[^>]*>/g,"");}
function cleanI(i){return i.replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim();}
function timeAgo(iso){const m=Math.floor((new Date()-new Date(iso))/60000);if(m<60)return m+"m ago";if(m<1440)return Math.floor(m/60)+"h ago";return Math.floor(m/1440)+"d ago";}
init();
</script>
</body>
</html>
